



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Neuron Segmentation &mdash; connectomics latest documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.svg"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/css/pytc-theme.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@1.0.0-alpha.28/dist/style.min.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Mitochondria Segmentation" href="mito.html" />
    <link rel="prev" title="Data Loading" href="../notes/dataloading.html" /> 

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">

    <a class="header-logo" href="https://zudi-lin.github.io/pytorch_connectomics/build/html/index.html" aria-label="PyTorch"></a>

    <div class="header-container">

      <div class="main-menu">
        <ul>
          <li>
            <a href="../index.html">Get Started</a>
          </li>
          <li>
            <a href="snemi.html">Tutorials</a>
          </li>
          <li>
            <a href="../index.html">Docs</a>
          </li>
          <li>
            <a href="https://github.com/zudi-lin/pytorch_connectomics/tree/master">Github</a>
          </li>
          <li>
            <a href="../about.html">About Us</a>
          </li>

        </ul>
      </div>

      <!-- <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a> -->
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  latest
                </div>
              
            

            <div id="docsearch"></div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notes/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/config.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/dataloading.html">Data Loading</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Neuron Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mito.html">Mitochondria Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="synapse.html">Synapse Detection</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/data.html">connectomics.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/engine.html">connectomics.engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/model.html">connectomics.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/utils.html">connectomics.utils</a></li>
</ul>
<p class="caption"><span class="caption-text">Team</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/team.html">About Us</a></li>
</ul>

            
          
        </div>
      </div>

      


    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Neuron Segmentation</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/neuron.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="neuron-segmentation">
<h1>Neuron Segmentation<a class="headerlink" href="#neuron-segmentation" title="Permalink to this headline">¶</a></h1>
<p>This tutorial provides step-by-step guidance for neuron segmentation with SENMI3D benchmark datasets.
Dense neuron segmentation in electronic microscopy (EM) images belongs to the category of <strong>instance segmentation</strong>.
The methodology is to first predict the affinity map (the connectivity of each pixel to neighboring pixels)
with an encoder-decoder ConvNets and then generate the segmentation map using a standard
segmentation algorithm (e.g., watershed).</p>
<p>The evaluation of segmentation results is based on the <a class="reference external" href="https://en.wikipedia.org/wiki/Rand_index">Rand Index</a>
and <a class="reference external" href="https://en.wikipedia.org/wiki/Variation_of_information">Variation of Information</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Before running neuron segmentation, please take a look at the <a class="reference external" href="https://github.com/zudi-lin/pytorch_connectomics/tree/master/notebooks">notebooks</a>
to get familiar with the datasets and available utility functions in this package.</p>
</div>
<p>The main script to run the training and inference is <code class="docutils literal notranslate"><span class="pre">pytorch_connectomics/scripts/main.py</span></code>.
The pytorch target affinity generation is <a class="reference internal" href="../modules/data.html#connectomics.data.dataset.VolumeDataset" title="connectomics.data.dataset.VolumeDataset"><code class="xref py py-class docutils literal notranslate"><span class="pre">connectomics.data.dataset.VolumeDataset</span></code></a>.</p>
<div class="section" id="neuighboring-affinity-learning">
<h2>Neuighboring affinity learning<a class="headerlink" href="#neuighboring-affinity-learning" title="Permalink to this headline">¶</a></h2>
<p>The affinity value between two neighboring pixels (voxels) is 1 if they belong to the same instance and 0 if
they belong to different instances or at least one of them is a background pixel (voxel). An affinity map can
be regarded as a more informative version of boundary map as it contains the affinity to two directions in 2D inputs and
three directions (<cite>z</cite>, <cite>y</cite> and <cite>x</cite> axes) in 3D inputs.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/snemi_affinity.png"><img alt="../_images/snemi_affinity.png" src="../_images/snemi_affinity.png" style="width: 800px;" /></a>
</div>
<p>The figure above shows examples of EM images, segmentation and affinity map from the SNEMI3D dataset. Since the
3D affinity map has 3 channels, we can visualize them as RGB images.</p>
<div class="section" id="get-the-data">
<h3>1 - Get the data<a class="headerlink" href="#get-the-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>wget http://rhoana.rc.fas.harvard.edu/dataset/snemi.zip
</pre></div>
</div>
<p>For description of the SNEMI dataset please check <a class="reference external" href="https://vcg.github.io/newbie-wiki/build/html/data/data_em.html">this page</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since for a region with dense masks, most affinity values are 1, in practice, we usually widen the instance border (erode the instance mask)
to deal with the class imbalance problem and let the model make more conservative predictions to prevent merge error. This is done by
setting <code class="docutils literal notranslate"><span class="pre">DATASET.LABEL_EROSION</span> <span class="pre">=</span> <span class="pre">1</span></code>.</p>
</div>
</div>
<div class="section" id="run-training">
<h3>2 - Run training<a class="headerlink" href="#run-training" title="Permalink to this headline">¶</a></h3>
<p>Provide the <code class="docutils literal notranslate"><span class="pre">yaml</span></code> configuration files to run training:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 python -m torch.distributed.launch \
--nproc_per_node=2 --master_port=1234 scripts/main.py --distributed \
--config-base configs/SNEMI/SNEMI-Base.yaml \
--config-file configs/SNEMI/SNEMI-Affinity-UNet.yaml
</pre></div>
</div>
<p>The configuration files for training can be found in <code class="docutils literal notranslate"><span class="pre">configs/SNEMI/</span></code>.
We usually create a <code class="docutils literal notranslate"><span class="pre">datasets/</span></code> folder under <code class="docutils literal notranslate"><span class="pre">pytorch_connectomics</span></code> and put the SNEMI dataset there.
Please modify the following options according to your system configuration and data storage:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IMAGE_NAME</span></code>: Name of the volume file (HDF5 or TIFF).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LABEL_NAME</span></code>: Name of the label file (HDF5 or TIFF).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INPUT_PATH</span></code>: Path to both input files above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OUTPUT_PATH</span></code>: Path to store outputs (checkpoints and Tensorboard events).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NUM_GPUS</span></code>: Number of GPUs to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NUM_CPUS</span></code>: Number of CPU cores to use (for data loading).</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>By default, we use multi-process distributed training with one GPU per process (and multiple CPUs for data loading).
The model is wrapped with <a class="reference external" href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html">DistributedDataParallel</a> (DDP).
For more benefits of training with distributed data-parallel, please check <a class="reference external" href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html">this tutorial</a>.</p>
</div>
</div>
<div class="section" id="run-training-with-pretrained-model-optional">
<h3>3 - Run training with pretrained model (<em>optional</em>)<a class="headerlink" href="#run-training-with-pretrained-model-optional" title="Permalink to this headline">¶</a></h3>
<p>(<em>Optional</em>) To run training starting from pretrained weights, add a checkpoint file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 python -m torch.distributed.launch \
--nproc_per_node=2 --master_port=1234 scripts/main.py --distributed \
--config-base configs/SNEMI/SNEMI-Base.yaml \
--config-file configs/SNEMI/SNEMI-Affinity-UNet.yaml \
--checkpoint /path/to/checkpoint/checkpoint_xxxxx.pth.tar
</pre></div>
</div>
</div>
<div class="section" id="visualize-the-training-progress">
<h3>4 - Visualize the training progress<a class="headerlink" href="#visualize-the-training-progress" title="Permalink to this headline">¶</a></h3>
<p>We use Tensorboard to visualize the training process. Specify <code class="docutils literal notranslate"><span class="pre">--logdir</span></code> with your own experiment directory, which can be different
from the default one.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tensorboard --logdir outputs/SNEMI3D/
</pre></div>
</div>
</div>
<div class="section" id="inference-of-affinity-map">
<h3>5 - Inference of affinity map<a class="headerlink" href="#inference-of-affinity-map" title="Permalink to this headline">¶</a></h3>
<p>Run inference on image volumes (add <code class="docutils literal notranslate"><span class="pre">--inference</span></code>). During inference the model can use larger batch sizes or take bigger inputs.
Test-time augmentation is also applied by default. We do not use distributed data-parallel during inference as the back-propagation
is not needed.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>python scripts/main.py --config-file configs/SNEMI-Neuron.yaml
--inference --checkpoint outputs/SNEMI3D/checkpoint_xxxxx.pth
</pre></div>
</div>
</div>
<div class="section" id="get-segmentation">
<h3>6 - Get segmentation<a class="headerlink" href="#get-segmentation" title="Permalink to this headline">¶</a></h3>
<p>The last step is to generate segmentation (with external post processing packages) and run
evaluation. First download the <code class="docutils literal notranslate"><span class="pre">waterz</span></code> package:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>git clone git@github.com:zudi-lin/waterz.git
cd waterz
pip install --editable .
</pre></div>
</div>
<p>Download the <code class="docutils literal notranslate"><span class="pre">zwatershed</span></code> package (optional):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>git clone git@github.com:zudi-lin/zwatershed.git
cd zwatershed
pip install --editable .
</pre></div>
</div>
<p>Generate 3D segmentation and report Rand and VI score using <code class="docutils literal notranslate"><span class="pre">waterz</span></code>. Please see examples at <a class="reference external" href="https://github.com/zudi-lin/waterz">https://github.com/zudi-lin/waterz</a>.</p>
</div>
</div>
<div class="section" id="long-range-affinity-learning">
<h2>Long-range affinity learning<a class="headerlink" href="#long-range-affinity-learning" title="Permalink to this headline">¶</a></h2>
<p>ToDo</p>
</div>
</div>


             </article>
             
            </div>
            <footer>
    
      <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
          <a href="mito.html" class="btn btn-neutral float-right" title="Mitochondria Segmentation" accesskey="n" rel="next">Next <img src="../_static/images/chevron-right-orange.svg" class="next-page"></a>
        
        
          <a href="../notes/dataloading.html" class="btn btn-neutral" title="Data Loading" accesskey="p" rel="prev"><img src="../_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
        
      </div>
    
  
    
  
      <hr>
  
    
  
    <div role="contentinfo">
      <p>
          &copy; Copyright 2019-2021, Zudi Lin and Donglai Wei.
  
      </p>
    </div>
      
        <div>
          Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
        </div>
       
  
  </footer>
          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Neuron Segmentation</a><ul>
<li><a class="reference internal" href="#neuighboring-affinity-learning">Neuighboring affinity learning</a><ul>
<li><a class="reference internal" href="#get-the-data">1 - Get the data</a></li>
<li><a class="reference internal" href="#run-training">2 - Run training</a></li>
<li><a class="reference internal" href="#run-training-with-pretrained-model-optional">3 - Run training with pretrained model (<em>optional</em>)</a></li>
<li><a class="reference internal" href="#visualize-the-training-progress">4 - Visualize the training progress</a></li>
<li><a class="reference internal" href="#inference-of-affinity-map">5 - Inference of affinity map</a></li>
<li><a class="reference internal" href="#get-segmentation">6 - Get segmentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#long-range-affinity-learning">Long-range affinity learning</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <!-- commented out for Ignite -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Harvard VCG</h2>
          <p>Visual Computing Group at Harvard</p>
          <a class="with-right-arrow" href="https://lichtmanlab.fas.harvard.edu">Harvard VCG</a>
        </div>
        <div class="col-md-4 text-center">
          <h2>Lichtman Lab</h2>
          <p>Lichtman Lab at Harvard</p>
          <a class="with-right-arrow" href="https://lichtmanlab.fas.harvard.edu">Lichtman Lab</a>
        </div>
        <div class="col-md-4 text-center">
          <h2>CBS</h2>
          <p>Center for Brain Science at Harvard</p>
          <a class="with-right-arrow" href="http://cbs.fas.harvard.edu">CBS</a>
        </div>
      </div>
    </div>
  </div>



  <!-- end of commented out for Ignite -->

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->
  <!--
  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://zudi-lin.github.io/pytorch_connectomics/build/html/index.html" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>
    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="#">Get Started</a>
          </li>
          <li>
            <a href="#">Features</a>
          </li>
          <li>
            <a href="#">Ecosystem</a>
          </li>
          <li>
            <a href="">Blog</a>
          </li>
          <li>
            <a href="https://zudi-lin.github.io/pytorch_connectomics/build/html/tutorials/snemi.html">Tutorials</a>
          </li>
          <li>
            <a href="https://zudi-lin.github.io/pytorch_connectomics/build/html/index.html">Docs</a>
          </li>
          <li>
            <a href="">Resources</a>
          </li>
          <li>
            <a href="https://github.com/zudi-lin/pytorch_connectomics/tree/master">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  -->
  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    var collapsedSections = ['Notes']
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@1.0.0-alpha.28/dist/umd/index.min.js"></script>
  <script type="text/javascript">
  let VERSION
  if ('latest'.includes('v')) {
    VERSION = 'latest'
  } else {
    VERSION = 'latest'
  }
  docsearch({
    container: '#docsearch',
    apiKey: '19a7a7a75d87608d6f42c722ed1e293f',
    indexName: 'ignite',
    placeholder: 'Search PyTC Docs',
    searchParameters: {
      'facetFilters': [`version:${VERSION}`],
    }
  });
  </script>
</body>
</html>